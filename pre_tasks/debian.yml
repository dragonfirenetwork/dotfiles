---
# pre_tasks/debian.yml

- name: Update APT package index
  apt:
    update_cache: yes
  become: yes
  tags:
    - pre_tasks

- name: Upgrade all installed packages to the latest version
  apt:
    upgrade: dist
  become: yes
  tags:
    - pre_tasks

- name: Install essential packages
  apt:
    name:
      - build-essential
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - sudo
      - wget
      - git
      - zsh
      - sshfs
      - net-tools
      - nmap
      - htop
      - btop
      - unzip
      - traceroute
      - dnsutils
      - iftop
      - cron
      - logrotate
      - netstat
      - zoxide
      - rsync
      - locales
      - language-pack-en
      - language-pack-jp
      - rar
      - unrar
      - xz-utils
      - ffmpeg
      - qemu-kvm
      - vagrant
    state: present
  become: yes
  tags:
    - pre_tasks
    - essentials

- name: ZSH
  block:
    - name: Check if .zshrc exists
      stat:
        path: "{{ ansible_env.HOME }}/.zshrc"
      register: zshrc_exists
    
    - name: Create .zshrc
      copy:
        dest: "{{ ansible_env.HOME }}/.zshrc"
        content: |
          export PATH="/usr/local/bin:$PATH"
          alias ll="ls -la"
        mode: '0644'
      when: not zshrc_exists.stat.exists

  tags:
    - pre_tasks
    - zsh

- name: Install Python packages
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
      - virtualenv
    state: present
  become: yes
  tags:
    - pre_tasks
    - python

- name: Ensure Python interpreter is set to Python 3
  set_fact:
    ansible_python_interpreter: /usr/bin/python3
  tags:
    - pre_tasks

- name: Install Docker and related packages
  block:
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      become: yes

    - name: Add Docker APT repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
        state: present
      become: yes

    - name: Update APT cache after adding Docker repository
      apt:
        update_cache: yes
      become: yes

    - name: Install Docker and related packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      become: yes

    - name: Add user to Docker group
      user:
        name: "{{ ansible_user | default('your_username') }}"
        groups: docker
        append: yes
      become: yes
  when: "'docker' in default_roles or 'docker' in run_roles"
  tags:
    - pre_tasks
    - docker_setup

# Check if .config exists, if not create it
- name: Ensure .config directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config"
    state: directory
    mode: '0755'
  tags:
    - pre_tasks